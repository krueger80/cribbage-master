<div *ngIf="state$ | async as state"
    class="p-1 md:p-4 bg-green-900 h-[100dvh] text-white font-sans relative overflow-hidden flex flex-col landscape:flex-row items-center landscape:items-stretch landscape:justify-start gap-0.5 landscape:gap-4 ml-safe mr-safe">

    <!-- Card Template -->
    <ng-template #cardTemplate let-card="card" let-size="size">
        <div class="absolute top-2 left-2 flex flex-col items-center">
            <span class="font-bold leading-none block"
                [ngClass]="{'text-lg': size !== 'sm', 'text-sm': size === 'sm'}">{{ card.rank
                }}</span>
            <span class="leading-none block -mt-2.5" [ngClass]="{'text-sm': size !== 'sm', 'text-xs': size === 'sm'}">{{
                getSuitSymbol(card.suit) }}</span>
        </div>
        <div class="flex items-center justify-center h-full pb-2">
            <div [ngClass]="{'text-4xl': size !== 'sm', 'text-2xl': size === 'sm'}">
                {{ getSuitSymbol(card.suit) }}
            </div>
        </div>
        <div class="absolute bottom-2 right-2 flex flex-col items-center transform rotate-180">
            <span class="font-bold leading-none block"
                [ngClass]="{'text-lg': size !== 'sm', 'text-sm': size === 'sm'}">{{ card.rank
                }}</span>
            <span class="leading-none block -mt-2.5" [ngClass]="{'text-sm': size !== 'sm', 'text-xs': size === 'sm'}">{{
                getSuitSymbol(card.suit) }}</span>
        </div>
    </ng-template>

    <!-- Victory Screen (Overlay) -->
    <div *ngIf="state.phase === 'gameover'"
        class="fixed inset-0 bg-black/90 z-[100] flex flex-col items-center justify-center p-8 animate-fade-in">
        <h1
            class="text-6xl md:text-8xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-yellow-500 mb-8 drop-shadow-lg">
            {{ state.winnerId === bottomPlayer.id ? ('GAME.VICTORY' | translate) : ('GAME.DEFEAT' | translate) }}
        </h1>
        <p class="text-2xl text-amber-100/80 tracking-widest uppercase mb-12">
            {{ state.winnerId === bottomPlayer.id ? ('GAME.VICTORY_MSG' | translate) : ('GAME.DEFEAT_MSG' | translate)
            }}
        </p>

        <div class="flex gap-16 mb-12">
            <div *ngFor="let p of state.players"
                class="flex flex-col items-center p-6 bg-white/5 rounded-2xl border border-white/10"
                [class.border-yellow-400]="p.id === state.winnerId"
                [class.shadow-[0_0_30px_rgba(250,204,21,0.2)]]="p.id === state.winnerId">
                <div class="text-4xl font-bold mb-2" [class.text-yellow-400]="p.id === state.winnerId">{{ p.score }}
                </div>
                <div class="text-sm uppercase tracking-wider text-slate-400">{{ getPlayerNameKey(p.name) | translate }}
                </div>
            </div>
        </div>

        <button (click)="restartGame()"
            class="px-8 py-4 bg-green-600 hover:bg-green-500 text-white rounded-full font-bold text-xl shadow-lg hover:scale-105 transition-all">
            {{ 'GAME.PLAY_AGAIN' | translate }}
        </button>
    </div>

    <!-- Real Score Board -->
    <div
        class="shrink-0 w-full h-24 landscape:w-24 landscape:h-auto bg-[#3e2723] rounded-lg border-2 border-[#5d4037] shadow-xl overflow-hidden relative">
        <app-cribbage-board [p1Score]="getVisualScore(0)" [p2Score]="getVisualScore(1)" [p1Color]="'#ef4444'"
            [p2Color]="'#3b82f6'" [vertical]="isLandscape">
        </app-cribbage-board>
    </div>

    <!-- Main Game Area -->
    <div
        class="w-full max-w-lg landscape:max-w-none flex-1 flex flex-col justify-between gap-1 landscape:gap-0 h-auto py-2 shrink-0 landscape:self-stretch">

        <!-- OPPONENT AREA (Top) -->
        <div
            class="relative flex items-center justify-between bg-green-800/30 rounded-xl p-1 landscape:p-2 border border-white/5 gap-2 w-full basis-0 flex-1 min-h-0 overflow-visible">

            <div
                class="info-card relative flex flex-col items-center justify-center bg-black/40 rounded-xl p-1 shrink-0 z-10 transition-all gap-0.5 landscape:gap-1">
                <!-- Avatar Placeholder -->
                <div
                    class="w-8 h-8 landscape:w-6 landscape:h-6 md:w-12 md:h-12 bg-white/10 rounded-full flex items-center justify-center">
                    <span class="text-xl landscape:text-sm md:text-xl">ðŸ¤–</span>
                </div>
                <div class="text-emerald-300 font-bold text-[10px] md:text-sm text-center leading-none">
                    {{ getPlayerNameKey(topPlayer.name) | translate }}</div>
                <div class="text-white font-black text-base landscape:text-lg md:text-xl leading-none">{{
                    topPlayer.score }}</div>
                <span *ngIf="topPlayer.isDealer"
                    class="absolute top-1 right-1 text-yellow-400 text-[9px] uppercase border border-yellow-400 px-1 rounded">D</span>
            </div>

            <!-- Right: Cards -->
            <div
                class="flex-1 flex justify-center -space-x-10 md:-space-x-12 xl:-space-x-4 transition-all duration-300 pr-1">
                <!-- If showing counting or finished, show faces -->
                <ng-container
                    *ngIf="state.phase === 'counting' && (localCountingStage !== 'non_dealer_hand' || !topPlayer.isDealer); else hiddenCards">
                    <!-- Show Opponent Played Cards (Hand) -->
                    <div *ngFor="let c of topPlayer.playedCards; let i = index" class="playing-card bg-white"
                        [style.z-index]="i" [ngClass]="getCardClasses(c, -1)">
                        <ng-container *ngTemplateOutlet="cardTemplate; context: {card: c}"></ng-container>
                    </div>
                </ng-container>

                <ng-template #hiddenCards>
                    <!-- Backs -->
                    <div *ngFor="let c of topPlayer.cards; let i = index" [style.z-index]="i"
                        class="playing-card !bg-blue-800 !border-2 !border-white !flex !items-center !justify-center overflow-hidden shadow-md">
                        <div class="w-full h-full opacity-30">
                            <!-- Plain blue back -->
                        </div>
                    </div>
                </ng-template>
            </div>

            <!-- Opponent Score Bubble REMOVED -->
        </div>

        <!-- CENTER AREA (Board / Pegging) -->
        <div
            class="w-full flex-[1.5] md:flex-[2] flex flex-col items-center justify-center gap-1 relative min-h-0 shrink-0 flex-1 landscape:flex-1">

            <!-- LEFT REGION: Cut Card & Crib -->
            <div class="absolute left-0 top-0 bottom-0 w-1/3 md:w-1/4 pointer-events-none z-30">

                <!-- Cut Card (Centered Vertically) -->
                <div class="absolute top-1/2 -translate-y-1/2 left-2 md:left-8 z-10 transition-all duration-300">
                    <div *ngIf="state.cutCard" class="playing-card animate-fade-in"
                        [ngClass]="getCardClasses(state.cutCard, -1)">
                        <ng-container *ngTemplateOutlet="cardTemplate; context: {card: state.cutCard}"></ng-container>
                    </div>
                    <div *ngIf="!state.cutCard"
                        class="playing-card !bg-blue-800 border-dashed border-2 border-white/20"></div>
                </div>

                <!-- Crib (To the Right of Cut Card) -->
                <div *ngIf="state.phase === 'counting' && localCountingStage === 'crib'"
                    class="absolute z-20 flex flex-col items-center justify-center w-auto animate-fade-in transition-all duration-500 left-12 md:left-32 top-1/2 -translate-y-1/2">

                    <div class="relative flex justify-center -space-x-10 mb-8">
                        <div *ngFor="let c of state.crib; let i = index" class="playing-card shadow-2xl bg-white"
                            [style.z-index]="i" [ngClass]="getCardClasses(c, -1)">
                            <ng-container *ngTemplateOutlet="cardTemplate; context: {card: c}"></ng-container>
                        </div>
                        <div
                            class="absolute bottom-2 left-1/2 -translate-x-1/2 bg-black/80 px-3 py-1 rounded-full border border-white/20 backdrop-blur-md z-40 whitespace-nowrap shadow-lg">
                            <span class="text-yellow-400 font-bold uppercase tracking-wider text-[10px]">{{ 'GAME.CRIB'
                                |
                                translate }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pegging Board (Center) -->
            <div class="w-full h-full flex items-center justify-center p-2 z-40 relative">

                <!-- Cards Stack -->
                <div class="relative w-full h-full max-h-32 md:max-h-64 flex items-center justify-center -space-x-8">

                    <!-- Placeholders/Empty State -->
                    <div *ngIf="state.peggingStack.length === 0 && state.phase === 'pegging'"
                        class="absolute border-2 border-dashed border-white/10 rounded-xl w-24 h-32 flex items-center justify-center">
                        <span class="text-white/20 text-sm font-bold">{{ 'GAME.TABLE_EMPTY' | translate }}</span>
                    </div>

                    <!-- The Stack -->
                    <ng-container *ngFor="let item of state.peggingStack; let i = index; trackBy: trackPeggingItem">
                        <div @cardPlay class="playing-card shadow-2xl transition-all duration-300 transform-gpu"
                            [ngClass]="getCardClasses(item.card, -1, item.playerId)"
                            [style.transform]="'rotate(' + ((i * 7) % 12 - 6) + 'deg)'" [style.z-index]="i">
                            <ng-container *ngTemplateOutlet="cardTemplate; context: {card: item.card}"></ng-container>

                            <!-- Last Played Bubble REMOVED -->
                        </div>
                    </ng-container>

                    <!-- Current Count -->
                    <div
                        class="absolute right-4 md:right-12 top-1/2 -translate-y-1/2 flex flex-col items-center justify-center z-0 pointer-events-none opacity-80">
                        <span
                            class="text-[3rem] md:text-[5rem] leading-[0.8] font-black text-amber-100 drop-shadow-lg">{{
                            state.currentPeggingTotal }}</span>
                        <span
                            class="text-[8px] md:text-xs uppercase font-bold text-amber-200/60 tracking-widest">Total</span>
                    </div>
                </div>
            </div>

            <!-- "Say Go" Action Area (Fixed at bottom) -->
            <div *ngIf="showSayGo" class="fixed bottom-8 left-0 right-0 flex justify-center z-[60] pointer-events-none">
                <button (click)="sayGo(bottomPlayer.id)"
                    class="pointer-events-auto bg-emerald-500 hover:bg-emerald-400 text-black font-black py-3 px-8 landscape:py-2 landscape:px-6 rounded-xl text-lg landscape:text-base uppercase tracking-widest shadow-lg border-2 border-emerald-300 active:scale-95 transition-transform">
                    {{ 'GAME.SAY_GO' | translate }}
                </button>
            </div>

            <!-- "Your Turn" Indicator REMOVED (Now integrated into player info blink) -->

        </div>

        <!-- PLAYER AREA (Bottom) -->
        <div
            class="relative flex items-center justify-between bg-green-800/30 rounded-xl p-1 landscape:p-2 border border-white/5 pb-safe gap-2 w-full basis-0 flex-1 min-h-0 overflow-visible">

            <!-- Left: Player Info / Avatar Area -->
            <div class="info-card relative flex flex-col items-center justify-center bg-black/40 rounded-xl p-1 shrink-0 z-10 transition-all gap-0.5 landscape:gap-1"
                [ngClass]="{'ring-2 ring-emerald-400 shadow-[0_0_15px_rgba(52,211,153,0.6)] animate-pulse': isMyTurn && !showSayGo && state.phase === 'pegging'}">
                <!-- Avatar Placeholder -->
                <div
                    class="w-8 h-8 landscape:w-6 landscape:h-6 md:w-12 md:h-12 bg-white/10 rounded-full flex items-center justify-center">
                    <span class="text-xl landscape:text-sm md:text-xl">ðŸ‘¤</span>
                </div>
                <div class="text-emerald-300 font-bold text-[10px] md:text-sm text-center leading-none">{{
                    getPlayerNameKey(bottomPlayer.name) | translate }}</div>
                <div class="text-white font-black text-base landscape:text-lg md:text-xl leading-none">{{
                    bottomPlayer.score }}</div>
                <span *ngIf="bottomPlayer.isDealer"
                    class="absolute top-1 right-1 text-yellow-400 text-[9px] uppercase border border-yellow-400 px-1 rounded">D</span>
            </div>

            <!-- Right: Cards -->
            <div
                class="flex-1 flex justify-center -space-x-10 md:-space-x-12 xl:-space-x-4 transition-all duration-300 pr-1">

                <!-- Normal Play / Discarding -->
                <ng-container *ngIf="state.phase !== 'counting'">
                    <div *ngFor="let c of bottomPlayer.cards; let i = index" (click)="onCardClick(i)"
                        class="playing-card cursor-pointer transition-transform bg-white" [style.z-index]="i"
                        [ngClass]="getCardClasses(c, i)">
                        <ng-container *ngTemplateOutlet="cardTemplate; context: {card: c}"></ng-container>
                    </div>
                </ng-container>

                <!-- Counting Phase: Show PlayedCards (Hand) -->
                <ng-container *ngIf="state.phase === 'counting'">
                    <div *ngFor="let c of bottomPlayer.playedCards; let i = index"
                        class="playing-card transition-transform bg-white" [style.z-index]="i"
                        [ngClass]="getCardClasses(c, i)">
                        <ng-container *ngTemplateOutlet="cardTemplate; context: {card: c}"></ng-container>
                    </div>
                </ng-container>
            </div>

            <!-- Discard Button (Fixed at bottom) -->
            <div *ngIf="state.phase === 'discarding' && selectedCardIndices.size === 2"
                class="fixed bottom-8 left-0 right-0 flex justify-center z-[60] pointer-events-none">
                <button (click)="discard()"
                    class="pointer-events-auto bg-emerald-500 hover:bg-emerald-400 text-black font-black py-3 px-8 landscape:py-2 landscape:px-6 rounded-xl text-lg landscape:text-base uppercase tracking-widest shadow-lg border-2 border-emerald-300 active:scale-95 transition-transform">
                    {{ 'GAME.CONFIRM_DISCARD' | translate }}
                </button>
            </div>

            <!-- Player Score Bubble REMOVED -->
        </div>
    </div>

    <!-- New Popup Component -->
    <app-score-popup [points]="getPopupData().points" [breakdown]="getPopupData().breakdown"
        [type]="getPopupData().type" [visible]="getPopupData().visible" [title]="getPopupData().title"
        (continue)="advanceCounting()">
    </app-score-popup>
</div>